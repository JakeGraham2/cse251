<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.333">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>prepare</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="prepare_files/libs/clipboard/clipboard.min.js"></script>
<script src="prepare_files/libs/quarto-html/quarto.js"></script>
<script src="prepare_files/libs/quarto-html/popper.min.js"></script>
<script src="prepare_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="prepare_files/libs/quarto-html/anchor.min.js"></script>
<link href="prepare_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="prepare_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="prepare_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="prepare_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="prepare_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">



<p><img src="../site/banner.png" class="img-fluid"></p>
<section id="prepare-course-introduction" class="level1">
<h1>01 Prepare: Course Introduction</h1>
</section>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>The first week of the course is an introduction to the topic of parallelism and concurrency. Since this course uses the programming language Python for assignments, we will spend some of the first week reviewing the Python language and Python packages that we will be using.</p>
<p>Please carefully read the syllabus so you will know how to best allocate your time and focus your efforts. The Syllabus is found in Canvas (I-Learn).</p>
</section>
<section id="preparation-material" class="level1">
<h1>Preparation Material</h1>
<p>This course assumes that you have programmed in Python using classes. Please refer to <a href="../overview/software.md">Software Requirements</a> for details and a review of Python.</p>
</section>
<section id="course-introduction" class="level1">
<h1>Course Introduction</h1>
<p><strong>What is concurrency?</strong></p>
<blockquote class="blockquote">
<p>In computer science, concurrency is the ability of different parts or units of a program, algorithm, or problem to be executed out-of-order or in partial order, without affecting the final outcome. This allows for parallel execution of the concurrent units, which can significantly improve overall speed of the execution in multi-processor and multi-core systems. In more technical terms, concurrency refers to the decomposability property of a program, algorithm, or problem into order-independent or partially-ordered components or units</p>
</blockquote>
<p>Example of concurrency are: - Chrome Browser - Website server node.js <a href="https://nodejs.org/en/">website</a> - An Operating System running on a 1 cpu core computer</p>
<p>– <a href="https://en.wikipedia.org/wiki/Concurrency_(computer_science)">Definition of Concurrency</a></p>
<p><strong>What is parallelism?</strong></p>
<blockquote class="blockquote">
<p>Parallel computing is a type of computation where many calculations or the execution of processes are carried out simultaneously. Large problems can often be divided into smaller ones, which can then be solved at the same time.</p>
</blockquote>
<p>Example of parallelism are: - Graphical Cards (GPU) - long numeric calculations - Computer games - Compression software - Operating System running on many cpu cores</p>
<p>– <a href="https://en.wikipedia.org/wiki/Parallel_computing">Definition of Parallelism</a></p>
<p>The main difference between concurrency and parallelism is that parallelism has processes that are running simultaneously, while concurrency only has one process executing at one time.</p>
<section id="io-bound--vs--cpu-bound" class="level2">
<h2 class="anchored" data-anchor-id="io-bound--vs--cpu-bound">I/O Bound -VS- CPU Bound</h2>
<p>Researchers have studied software and note that there are generally two different stages that programs switches many times during their execution. They are Input/Output bound and cpu bound.</p>
<p><strong>I/O Bound</strong></p>
<p><a href="https://en.wikipedia.org/wiki/I/O_bound">I/O Bound</a> refers to a condition in which the time it takes to complete a computation is determined principally by the period spent waiting for input/output operations to be completed. For example: Waiting for the user to enter something, file access (reading and writing), Internet requests, etc…</p>
<p>In Python, we’ll be using threads for I/O bound problems.</p>
<p><strong>CPU Bound</strong></p>
<p><a href="https://en.wikipedia.org/wiki/CPU-bound">CPU Bound</a> refers to a situation when the time for a task to complete is determined principally by the speed of the central processor or the number of processors. Once a program has all of the data it needs to do work, it will be spending it’s time using the CPU.</p>
<p>In Python, we’ll be using processes for CPU bound programs.</p>
<p>Quote from https://rednafi.github.io/digressions/python/2020/04/21/python-concurrent-futures.html</p>
<blockquote class="blockquote">
<p>In Python, if the task at hand is I/O bound, you can use use standard library’s <code>threading</code> module or if the task is CPU bound then <code>multiprocessing</code> module can be your friend. These <code>threading</code> and <code>multiprocessing</code> APIs give you a lot of control and flexibility but they come at the cost of having to write relatively low-level verbose code that adds extra layers of complexity on top of your core logic. Sometimes when the target task is complicated, it’s often impossible to avoid complexity while adding concurrency. However, a lot of simpler tasks can be made concurrent without adding too much extra overhead.</p>
</blockquote>
<p>We will be focusing on the threading module for the first 2 weeks of the course. Then, multi-processes for the next 3 weeks.</p>
</section>
<section id="threading-package" class="level2">
<h2 class="anchored" data-anchor-id="threading-package">Threading Package</h2>
<p>For the first two weeks of the course, we are learning how to add threads to our programs. We will be using the threading package. It is included in your Python program using the following:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="what-is-a-thread" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-thread">What is a thread?</h2>
<p>This quote is from: <a href="https://en.wikipedia.org/wiki/Thread_(computing)">Thread (computing)</a> &gt; In computer science, a thread of execution is the smallest sequence of programmed instructions that can be managed independently by a scheduler, which is typically a part of the operating system. The implementation of threads and processes differs between operating systems, but in most cases a thread is a component of a process. Multiple threads can exist within one process, executing concurrently and sharing resources such as memory, while different processes do not share these resources. In particular, the threads of a process share its executable code and the values of its dynamically allocated variables and non-thread-local global variables at any given time.</p>
<p>In the previous Python program that you wrote, there was always one thread running in your program. This is called the <code>main thread</code>. All programs have this main thread and only uses one CPU core on a computer. With computers now having 8, 16, 32, etc… cores, we need to write programs that can use those multiple cores.</p>
<section id="timer-function-in-the-threading-package" class="level3">
<h3 class="anchored" data-anchor-id="timer-function-in-the-threading-package">Timer() function in the threading package</h3>
<p>The <code>timer()</code> function allows you to run a function in the future by indicating the amount of time in seconds. The following code will create a timer that will call the function <code>display_hello()</code> in 3 seconds when the thread is started.</p>
<p>In the statement <code>thread = threading.Timer(3.0, display_hello)</code>, the function <code>display_hello</code> is passed to the Timer. There are no <code>()</code> used for a function that is passed as an argument to a function.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_hello():</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Hello, World!"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Before the thread'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>thread <span class="op">=</span> threading.Timer(<span class="fl">3.0</span>, display_hello)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>thread.start()</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'After the thread - End of program'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here is the output of the above program. Notice that the text <code>Hello World</code> was displayed after the text <code>After the thread - End of program</code>. The reason for this is that the main thread will continue to run after it starts the timer (ie., <code>thread.start()</code>) The program ends when the main thread and the timer are finished.</p>
<pre><code>Before the thread
After the thread - End of program
Hello, World!</code></pre>
</section>
<section id="thread-example" class="level3">
<h3 class="anchored" data-anchor-id="thread-example">Thread Example</h3>
<p>Here is an example of creating, starting and ending a thread. We will be going in more detail in next lesson.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread_function(name, sleep_time):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""This is the function the thread will run"""</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Thread "</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">": starting'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    time.sleep(sleep_time)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Thread "</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">": finishing'</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : before creating thread'</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a thread.  This doesn't start it, just it's creation</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The args argument allow the main code to pass arguments to the</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># thread.</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we DON'T want any global variables in this case.</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note: if you are wondering about the ',' after 'Sleep Function',</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># please review tuples in Python.</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> threading.Thread(target<span class="op">=</span>thread_function, args<span class="op">=</span>(<span class="st">'Sleep Function'</span>, <span class="dv">2</span>))</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : before running thread'</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The code here in main will start the thread and then keep</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># executing. It will not wait for the thread to return. </span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    t.start()</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : wait for the thread to finish'</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Joining a thead back to the main thread is waiting for the</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># created thread to finish.</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    t.join()</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : all done'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Program output</p>
<pre class="text"><code>Main    : before creating thread
Main    : before running thread
Thread "Sleep Function": starting
Main    : wait for the thread to finish
Thread "Sleep Function": finishing
Main    : all done</code></pre>
</section>
<section id="starting-and-waiting-for-it-to-finish" class="level3">
<h3 class="anchored" data-anchor-id="starting-and-waiting-for-it-to-finish">Starting and waiting for it to finish</h3>
<p>There are two methods used for starting and waiting for class threads.</p>
<p><strong>start()</strong></p>
<p>This is a non-blocking function call. Start() will start the thread running and will return to the caller. It doesn’t wait for the thread to execute. In designing programs that use threads, there are a few guiding principles:</p>
<ol type="1">
<li>Don’t use sleep() to control the order of when threads run. The course uses <code>sleep()</code> in some assignments and team activities just to slow execution down to simulate the thread doing meaningful work.</li>
<li>When you start a group of threads, you as a programmer should not assume any order of execution of these threads. For example: if you create two threads (t1 and t2), and start them in the order of <code>t1.start()</code> then <code>t2.start()</code>. You should not assume that <code>t1</code> is going to run first before <code>t2</code>.</li>
</ol>
<p><strong>join()</strong></p>
<p>This is a blocking function call. Join() will wait until that thread is finished executing. If the thread is still busy doing something, then join() will not return until it’s finished. If the thread never finishes, then your program will hang (deadlock) on <code>join()</code>.</p>
</section>
</section>
<section id="the-importance-of-__main__" class="level2">
<h2 class="anchored" data-anchor-id="the-importance-of-__main__">The importance of <code>__main__</code></h2>
<p>In Python, there are special run-time variables that are available to programmers. Python programs don’t need a “main” function if there is only one file in your program. Where you have multiple files, Python needs to know which file contains the “main” code. The variable <code>__name__</code> is used to denote if a file is the main file. <a href="https://docs.python.org/3/library/__main__.html">More details on <code>__main__</code></a></p>
<p><a href="https://www.youtube.com/watch?v=lOeIDvyRUQs">Video on why __name__ is important</a></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># execute only if run as a script (ie., the main file)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When writting multi-processor programs that have multiple files, you must test for <code>if __name_ == "__main__":</code> or else Python will start running your program from different files as each process is created.</p>
<p>Note: the function <code>dir()</code> can display the current builtin functions in your program.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="bu">print</span>(<span class="bu">dir</span>())</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>[<span class="st">'__annotations__'</span>, <span class="st">'__builtins__'</span>, <span class="st">'__cached__'</span>, <span class="st">'__doc__'</span>, <span class="st">'__file__'</span>, <span class="st">'__loader__'</span>, <span class="st">'__name__'</span>, <span class="st">'__package__'</span>, <span class="st">'__spec__'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="differences-between-threads-and-processes" class="level2">
<h2 class="anchored" data-anchor-id="differences-between-threads-and-processes">Differences between threads and processes</h2>
<section id="python-global-interpreter-gil" class="level3">
<h3 class="anchored" data-anchor-id="python-global-interpreter-gil">Python Global Interpreter (GIL)</h3>
<p>Before we can talk about threads and processes, we need to understand the Python Global Interpreter Lock or GIL. It is a mutex (or a lock) that allows only one thread to hold the control of the Python interpreter.</p>
<p>This means that only one thread can be in a state of execution at any one time. If you write single-threaded programs, then the GIL has no impact. However, when writing parallel and concurrent programs, it is critical to understand it.</p>
</section>
<section id="process" class="level3">
<h3 class="anchored" data-anchor-id="process">Process</h3>
<p>In terms of computer systems, a “process” is a program that has been loaded by the operating system and is running. It contains 1 to N threads. All processes contain 1 thread that is called the main thread. The operating system will start that main thread for the process and when that main thread ends, the process ends. <a href="https://en.wikipedia.org/wiki/Process_(computing)">Process (computing)</a></p>
</section>
<section id="thread" class="level3">
<h3 class="anchored" data-anchor-id="thread">Thread</h3>
<p>A thread is the smallest unit managed by the operating system that is scheduled to run on the CPU. <a href="https://en.wikipedia.org/wiki/Thread_(computing)">Thread (computing)</a></p>
</section>
<section id="how-python-handles-threads-and-processes" class="level3">
<h3 class="anchored" data-anchor-id="how-python-handles-threads-and-processes">How Python handles threads and processes</h3>
<p>Because of the GIL, all threads are running concurrently in your program. The operating system will give each thread a little time slice on the CPU and switch between them quickly giving the appearance that they are all running at the same time.</p>
<p>When you create a process in Python, each process will contain their own instance of a GIL. This allows each process to run in parallel on the computer.</p>
</section>
<section id="io-and-cpu-bound-code" class="level3">
<h3 class="anchored" data-anchor-id="io-and-cpu-bound-code">I/O and CPU Bound code</h3>
<p>Computer programs have been analyzed for many years and researchers have noticed that during the life of a running process, the process will <strong>switch</strong> between waiting for I/O (ie., user input, Internet requests, file accesses) and running instructions on the CPU (ie., calculations).</p>
<p><strong>I/O Bound</strong></p>
<blockquote class="blockquote">
<p>In computer science, I/O bound refers to a condition in which the time it takes to complete a computation is determined principally by the period spent waiting for input/output operations to be completed. This is the opposite of a task being CPU bound. This circumstance arises when the rate at which data is requested is slower than the rate it is consumed or, in other words, more time is spent requesting data than processing it. <a href="https://en.wikipedia.org/wiki/I/O_bound">I/O Bound Webpage</a></p>
</blockquote>
<p>In Python, threads are used for I/O Bound problems</p>
<p><strong>CPU Bound</strong></p>
<blockquote class="blockquote">
<p>In computer science, a computer is CPU-bound (or compute-bound) when the time for it to complete a task is determined principally by the speed of the central processor: processor utilization is high, perhaps at 100% usage for many seconds or minutes. <a href="https://en.wikipedia.org/wiki/CPU-bound">CPU Bound Webpage</a></p>
</blockquote>
<p>In Python, processes are used for CPU Bound problems</p>
<p><strong>Summary</strong></p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th>thread</th>
<th>process</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Allow sharing of memory</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr class="even">
<td>Allow sharing of files handles</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr class="odd">
<td>Concurrent</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Parallel</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Quick To Create</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr class="even">
<td>New instance of GIL created</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Good for I/O Bound</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr class="even">
<td>Good for CPU Bound</td>
<td>No</td>
<td>Yes</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="creating-a-thread" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-thread">Creating a Thread</h2>
<p>Coding example of creating a child thread.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread_function(name):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""This is the function the thread will run"""</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Thread "</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">": starting'</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">2</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Thread "</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">": finishing'</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : before creating thread'</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> threading.Thread(target<span class="op">=</span>thread_function, args<span class="op">=</span>(<span class="st">'Bob'</span>,))</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : before running thread'</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    t.start()</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : wait for the thread to finish'</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    t.join()</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : all done'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s look again at the coding example above. There are three main steps:</p>
<ol type="1">
<li>Create a thread and give the thread a function to execute.</li>
</ol>
<p>Creation of a thread is handled by called the <code>Thread()</code> function in the <code>threading</code> module. The created thread is called the child thread and the thread that creates it is called the parent. (In the example below, it’s the main thread creating the thread <code>t</code>)</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> threading.Thread(target<span class="op">=</span>thread_function, args<span class="op">=</span>(<span class="st">'Bob'</span>,))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>target</strong> is used to pass the reference of the function you want to thread to execute.</p>
<p><strong>args</strong> is used to pass information to the threaded function. Note that this is a Python tuple. Tuples that only contain one item in them need to be created with the extra <code>,</code>. The number of arguments in your threaded function needs to match the count of the tuple.</p>
<ol start="2" type="1">
<li>Start the thread.</li>
</ol>
<p>A thread doesn’t start to execute until you call the start() method. This allows you to create all of the threads required for your task and then start them when needed.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>t.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Wait for the thread to finish.</li>
</ol>
<p>The parent thread has full control of any child threads that are created and can wait for the child threads to finish. The function <code>join()</code> is used for this purpose. Think of the parent thread waiting for the child threads to “re-join” the parent.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>t.join()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Program output</p>
<pre class="text"><code>Main    : before creating thread
Main    : before running thread
Thread "Bob": starting
Main    : wait for the thread to finish
Thread "Bob": finishing
Main    : all done</code></pre>
<p>Here is an example of creating 3 threads all using the same function.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread_function(name, sleep_time):</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""This is the function the thread will run"""</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Thread "</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">": starting'</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    time.sleep(sleep_time)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Thread "</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">": finishing'</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : before creating thread'</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a threads</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    t1 <span class="op">=</span> threading.Thread(target<span class="op">=</span>thread_function, args<span class="op">=</span>(<span class="st">'Bob'</span>, <span class="dv">3</span>))</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    t2 <span class="op">=</span> threading.Thread(target<span class="op">=</span>thread_function, args<span class="op">=</span>(<span class="st">'Jim'</span>, <span class="dv">2</span>))</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    t3 <span class="op">=</span> threading.Thread(target<span class="op">=</span>thread_function, args<span class="op">=</span>(<span class="st">'Mary'</span>, <span class="dv">1</span>))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : before running thread'</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    t1.start()</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    t2.start()</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    t3.start()</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : wait for the thread to finish'</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    t1.join()</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    t2.join()</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    t3.join()</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Main    : all done'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Output</p>
<pre><code>Main    : before creating thread
Main    : before running thread
Thread "Bob": starting
Thread "Jim": starting
Thread "Mary": starting
Main    : wait for the thread to finish
Thread "Mary": finishing
Thread "Jim": finishing
Thread "Bob": finishing
Main    : all done</code></pre>
</section>
<section id="critical-sections" class="level2">
<h2 class="anchored" data-anchor-id="critical-sections">Critical Sections</h2>
<p>Although the GIL will run threads concurrently (ie., one at a time switching quickly between them), you still might need to protect shared data between threads.</p>
<p>For Example: let’s say that you have threads that are using a file as a counter (I know that this is a made up example). The file will contain an integer that is the count.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread_func(filename, count):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> <span class="bu">open</span>(filename, <span class="st">'w'</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    f.write(count)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    f.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This works great in a single-threaded program. But when we have, say two threads, it can become a problem. Remember, you as the programmer can’t control which thread runs on the cpu, or when the operating system will switch to another thread and for how long they will run when they have the CPU.</p>
<table class="table">
<thead>
<tr class="header">
<th>Thread A</th>
<th>Thread B</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>f = open(filename, ‘w’)</td>
<td></td>
</tr>
<tr class="even">
<td>f.write(count)</td>
<td></td>
</tr>
<tr class="odd">
<td>OS switchs to thread B ==&gt;</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>f = open(filename, ‘w’)</td>
</tr>
<tr class="odd">
<td></td>
<td>Program crashes because the file is locked by thread A</td>
</tr>
</tbody>
</table>
<p>In the table above, Thread <code>B</code> will crash when trying to open the file in write only mode. This is because Thread <code>A</code> never finished closing the file before Thread <code>B</code> started.</p>
<p>Python allows you to denote part of your code as a critical section. A critical section is code that only allows 1 thread to execute at a time. That thread will start and finish executing the code before any other thread can execute it. <a href="https://en.wikipedia.org/wiki/Critical_section">Critical Section webpage</a></p>
<p>In the figure, 4 threads are tyring to get into the critical section.</p>
<p><img src="synchronizing.jpg" class="img-fluid"></p>
<p>To create a critical section, we will be using the Lock() method in the <code>threading</code> module. Calls to <code>acquire()</code> and <code>release()</code> need to match. If your code doesn’t release a lock, then your program will hang on the next call to <code>acquire()</code>. This is called Dead Lock.</p>
<p>You will slow your program if you use too many locks or use them when other solutions are available that don’t require locks.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>lock <span class="op">=</span> threading.Lock()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread_func(filename, count):</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># acquire the lock before entering the critical section</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If another thread has the lock, this thread will wait</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># until it's released.</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    lock.acquire()</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Do your stuff.  Only 1 thread is running this code</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> <span class="bu">open</span>(filename, <span class="st">'w'</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    f.write(count)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    f.close()</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># release the lock.  If you fail to release the lock,</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the next thread that tried to acquire the lock will</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># wait forever since the release will never happen.</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    lock.release()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="deamon-threads" class="level2">
<h2 class="anchored" data-anchor-id="deamon-threads">Deamon Threads</h2>
<p>Python also has deamon threads. (Note, we are not using them in the course). They are mentioned here in case you read about them in your research.</p>
<blockquote class="blockquote">
<p>A Daemon Thread is a type of thread that can run independently in the background. These kinds of threads execute independently of the main thread. So these are called non-blocking threads.</p>
</blockquote>
<p>The issue with deamon threads is that they are abruptly stopped at shutdown. Their resources (memory, files, database transactions, etc.) may not be released properly.</p>
<blockquote class="blockquote">
<p><strong>From the Instructor</strong></p>
<p>Reading is key to doing well in this course. You will be required to read the provided material each week. Take your time and read the material more than once if you don’t understand it the first time.</p>
</blockquote>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>